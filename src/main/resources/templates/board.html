<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Test Board</title>
    <style>

        body {
            font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px;
        }
        h1 {
            color: #333;
        }
        .container {
            max-width: 100%; margin: auto;
        }
        table {
            width: 100%; border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd; padding: 8px; text-align: left;
        }
        th {
            background: #f2f2f2;
        }
        .btn {
            display: inline-block; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            z-index: 1000;
        }

        .popup input, .popup textarea {
            width: 100%;
            margin-bottom: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>게시판</h1>
        <p>현재 사용자 : <span id="currentUser"></span></p>
        <a href="#" class="btn" id="writeReview">글쓰기</a>
        <table id="postList">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>날짜</th>
                    <th>작성자</th>
                    <th>체육관 ID</th>
                    <th>내용</th>
                </tr>
            </thead>
            <tbody id="reviewTable">

            </tbody>
        </table>
    </div>

    <div id="reviewPopup" class="popup">
        <!-- 리뷰 작성 팝업 추가 -->
        <h2>리뷰 작성</h2>
        <input type="number" id="reviewGymId" placeholder="체육관 ID">
        <textarea id="reviewComment" placeholder="리뷰 내용"></textarea>
        <button onclick="submitReview()">확인</button>
        <button onclick="closePopup()">취소</button>
    </div>
    <div id="overlay" class="overlay"></div>
    <script>
        // 현재 로그인한 사용자 정보 (서버에서 제공해야 함)
        let currentUser = {
            userId: null,
            isAdmin: false // 관리자 여부
        };

        // 사용자 정보 가져오기
        function fetchUserInfo() {
            fetch('/api/user-info', {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {

                    if(!response.ok) {
                        throw new Error('로그인 상태가 아닙니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    currentUser.userId = data.userId;
                    currentUser.name = data.name;
                    document.getElementById('currentUser').textContent = data.name;
                })
                .catch(error => {
                    console.error('Error: ', error);
                    alert('사용자 정보를 불러오는데 실패했습니다. 다시 로그인해주세요.');
                    window.location.href = '/api/login';
                });
        }

        // 리뷰 목록 가져오기
        function fetchReviews() {
            fetch('/api/reviews/all', {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(reviews => {
                    console.log("Received Reviews : ", reviews);
                    const tbody = document.getElementById('reviewTable');
                    tbody.innerHTML = '';
                    reviews.forEach(review => {

                        const row = document.createElement('tr');
                        row.innerHTML =  `
                            <td>${review.rId || 'N/A'}</td>
                <td>${new Date(review.addedAt).toLocaleString()}</td>
                <td>${currentUser.name || 'N/A'}</td>
                <td>${review.gymId || 'N/A'}</td>
                <td>${review.comment || 'N/A'}</td>
                <td>
                    ${(review.userId === currentUser.userId || currentUser.isAdmin) ? `
                    <button onclick="editReview(${review.rId}, ${review.gymId})">수정</button>
                    <button onclick="deleteReview(${review.rId}, ${review.gymId}, '${review.userId}')">삭제</button>
                    ` : ''}
                </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error : ', error);
                    alert('리뷰를 불러오는데 실패했습니다.');
                })
        }



        // 리뷰 수정
        function editReview(reviewId, gymId) {
            const newComment = prompt('새로운 리뷰 내용을 입력하세요:');
            if (newComment) {
                fetch(`/api/reviews/${reviewId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ gymId, comment: newComment }),
                })
                    .then(response => response.json())
                    .then(() => {
                        fetchReviews(); // 목록 새로고침
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('리뷰 수정에 실패했습니다.');
                    });
            }
        }

        // 리뷰 삭제
        function deleteReview(reviewId, gymId, userId) {
            if (confirm('정말로 이 리뷰를 삭제하시겠습니까?')) {
                fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ gymId }),
                })
                    .then(() => {
                        fetchReviews(); // 목록 새로고침
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('리뷰 삭제에 실패했습니다.');
                    });
            }
        }

        // 글 작성 버튼 Event Listener
        document.getElementById('writeReview').addEventListener('click', () => {
            document.getElementById('reviewPopup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        });

        function closePopup() {
            document.getElementById('reviewPopup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            // 입력 필드 초기화
            document.getElementById('reviewGymId').value = '';
            document.getElementById('reviewComment').value = '';
        }

        // 리뷰작성
       function submitReview() {
            const gymId = document.getElementById('reviewGymId').value;
            const comment = document.getElementById('reviewComment').value;

            if(gymId && comment) {
                fetch('/api/reviews' , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gymId,
                        comment,
                        userId: currentUser.userId  // 현재 로그인한 사용자의 ID를 포함
                    }),
                    credentials: 'include' // 세션 쿠키를 포함시키기 위해 적용
                })
                    .then(response => {
                        if(!response.ok) {
                            if(response.status === 401) {
                                throw new Error('로그인이 필요합니다.');
                            }
                            throw new Error('리뷰 작성에 실패하였습니다.');
                        }
                        return response.json();
                    })
                    .then(() => {
                        alert('리뷰가 성공적으로 작성되었습니다.');
                        closePopup();
                        fetchReviews(); // 목록 새로고침
                    })
                    .catch(error => {
                        console.error('Error : ', error);
                        alert(error.message);
                    });
            } else {
                alert('체육관 ID와 리뷰 내용을 모두 입력해주세요.');
            }
       }

        // 초기화
        fetchUserInfo();
        fetchReviews();
    </script>
</body>
</html>