<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>체육관 목록</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .gym-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .gym-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .gym-card:hover {
      transform: translateY(-5px);
    }

    .gym-info {
      padding: 15px;
    }

    .gym-name {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .gym-category {
      display: inline-block;
      padding: 3px 8px;
      background-color: #007bff;
      color: white;
      border-radius: 15px;
      font-size: 0.9em;
      margin-bottom: 10px;
    }

    .gym-details {
      color: #666;
      font-size: 0.9em;
    }

    .gym-rating {
      color: #f8c51c;
      font-weight: bold;
      margin-top: 10px;
    }

    /* 로딩 표시를 위한 스타일 추가 */
    .loading {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: #666;
    }

    /* 에러 메시지를 위한 스타일 추가 */
    .error-message {
      background-color: #fff3f3;
      border: 1px solid #ffcdd2;
      color: #d32f2f;
      padding: 15px;
      border-radius: 5px;
      margin: 20px;
      text-align: center;
    }

    .debug-info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      max-width: 400px;
      max-height: 200px;
      overflow: auto;
      z-index: 1000;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      width: 90%;
      max-width: 800px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      position: relative;
      background-color: #f8f9fa;
      border-radius: 10px 10px 0 0;
    }

    .modal-title {
      margin: 0;
      font-size: 1.5em;
      color: #333;
    }

    .close-button {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-body {
      padding: 20px;
    }

    .gym-info {
      margin-bottom: 30px;
    }

    .gym-header {
      margin-bottom: 20px;
    }

    .gym-name {
      font-size: 1.8em;
      margin: 0 0 10px 0;
      color: #333;
    }

    .gym-category {
      display: inline-block;
      padding: 5px 15px;
      background-color: #007bff;
      color: white;
      border-radius: 20px;
      font-size: 0.9em;
    }

    .gym-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .info-label {
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      font-size: 0.9em;
    }

    .gym-rating {
      color: #ffc107;
      font-size: 1.2em;
    }

    .gym-reviews {
      border-top: 1px solid #eee;
      padding-top: 20px;
    }

    .gym-reviews h3 {
      margin: 0 0 20px 0;
      color: #333;
    }

    .reviews-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .review-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .review-rating {
      color: #ffc107;
    }

    .review-date {
      color: #666;
      font-size: 0.9em;
    }

    .review-content {
      color: #333;
      line-height: 1.5;
    }

    .review-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .reviewer-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .reviewer-profile {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .reviewer-details {
      display: flex;
      flex-direction: column;
    }

    .reviewer-name {
      font-weight: 600;
      font-size: 1rem;
      color: #333;
      margin-bottom: 2px;
    }

    .review-date {
      font-size: 0.85rem;
      color: #888;
    }

    .review-rating {
      color: #ffc107;
      font-size: 0.9rem;
    }

    .review-content {
      margin: 15px 0;
      line-height: 1.5;
      color: #444;
    }

    .review-images {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
    }

    .review-image {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }

    .review-actions {
      margin-top: 15px;
      display: flex;
      align-items: center;
    }

    .comment-button {
      display: flex;
      align-items: center;
      gap: 5px;
      background: none;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      color: #666;
      font-size: 0.9rem;
    }

    .comment-button:hover {
      color: #333;
    }

    .comment-icon {
      font-size: 1.2rem;
    }

    .comment-count {
      color: #666;
    }
  </style>
</head>
<body>
  <div class="gym-container" id="gymContainer">

    <!-- 에러 메시지 -->
    <div id="error" class="error-message" style="display: none;"></div>

    <!-- 디버그 정보를 표시할 div 추가 -->
    <div id="debugInfo" class="debug-info"></div>

    <div class="gym-card" onclick="location.href='/gyms/1'">
      <div class="gym-info">
        <div class="gym-name">체육관 이름</div>
        <div class="gym-category">체육관 카테고리</div>
        <div class="gym-details">
          <div>주소</div>
          <div>운영시간 정보 없음</div>
        </div>
        <div class="gym-rating">★ N/A</div>
      </div>
    </div>
    <div class="gym-card" onclick="location.href='/gyms/2'">
      <div class="gym-info">
        <div class="gym-name">체육관 이름</div>
        <div class="gym-category">체육관 카테고리</div>
        <div class="gym-details">
          <div>주소</div>
          <div>운영시간 정보 없음</div>
        </div>
        <div class="gym-rating">★</div>
      </div>
    </div>
  </div>
  <!-- 팝업 모달 추가 -->
  <div id="gymModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">체육관 상세 정보</h2>
        <span class="close-button" onclick="closeModal()">&times;</span>
      </div>
      <div id="gymDetailContent" class="modal-body">
        <div class="gym-info">
          <div class="gym-header">
            <h3 class="gym-name"></h3>
            <div class="gym-category"></div>
          </div>

          <div class="gym-info-grid">
            <div class="info-item">
              <div class="info-label">평점</div>
              <div class="gym-rating"></div>
            </div>
            <div class="info-item">
              <div class="info-label">주소</div>
              <div class="gym-address"></div>
            </div>
            <div class="info-item">
              <div class="info-label">운영시간</div>
              <div class="gym-hours"></div>
            </div>
            <div class="info-item">
              <div class="info-label">연락처</div>
              <div class="gym-phone"></div>
            </div>
            <div class="info-item">
              <div class="info-label">홈페이지</div>
              <div class="gym-homepage"></div>
            </div>
          </div>
        </div>

        <div class="gym-reviews">
          <h3>리뷰</h3>
          <div class="reviews-container"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    function fetchGyms() {
      const container = document.getElementById('gymContainer');
      const loading = document.getElementById('loading');
      const errorDiv = document.getElementById('error');

      // debugInfo 요소 확인 후 사용
      const debugInfo = document.getElementById('debugInfo');
      const isDebugMode = debugInfo !== null;

      // 로딩 표시
      if (loading) {
        loading.style.display = 'block';
      }
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }

      console.log('API 호출 시작');
      // debugInfo가 있을 때만 사용
      if (isDebugMode) {
        debugInfo.innerHTML = '데이터 로딩 중...';
      }

      fetch('/api/gyms', {
        credentials: 'include',
        headers: {
          'Accept': 'application/json'
        }
      })
              .then(response => {
                console.log('API 응답 상태:', response.status);
                if (isDebugMode) {
                  debugInfo.innerHTML += `<br>응답 상태: ${response.status}`;
                }

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(gyms => {
                console.log('받은 데이터:', gyms);
                if (isDebugMode) {
                  debugInfo.innerHTML += `<br>받은 데이터: ${JSON.stringify(gyms, null, 2)}`;
                }

                if (loading) {
                  loading.style.display = 'none';
                }

                if (container) {
                  container.innerHTML = '';

                  if (!Array.isArray(gyms)) {
                    throw new Error('데이터가 배열 형식이 아닙니다.');
                  }

                  gyms.forEach(gym => {
                    const gymCard = document.createElement('div');
                    gymCard.className = 'gym-card';
                    gymCard.onclick = () => {
                      console.log('카드 클릭됨:', gym.gymId);
                      showGymDetail(gym.gymId);
                    };

                    gymCard.innerHTML = `
                    <div class="gym-info">
                        <div class="gym-name">${gym.gname || '이름 없음'}</div>
                        <div class="gym-category">${translateCategory(gym.category)}</div>
                        <div class="gym-details">
                            <div>${gym.address || '주소 없음'}</div>
                        </div>
                        <div class="gym-rating">★ ${gym.rating || 'N/A'}</div>
                    </div>
                `;

                    container.appendChild(gymCard);
                  });
                }
              })
              .catch(error => {
                console.error('Error:', error);
                if (isDebugMode) {
                  debugInfo.innerHTML += `<br>에러 발생: ${error.message}`;
                }
                if (loading) {
                  loading.style.display = 'none';
                }
                if (errorDiv) {
                  errorDiv.style.display = 'block';
                  errorDiv.textContent = '체육관 정보를 불러오는데 실패했습니다. (' + error.message + ')';
                }
              });
    }

    // 나머지 함수들 (showGymDetail, closeModal 등) 유지
    function showGymDetail(gymId) {
      const modal = document.getElementById('gymModal');
      const detailContent = document.getElementById('gymDetailContent');

      if (!modal || !detailContent) {
        console.error('모달 요소를 찾을 수 없습니다.');
        return;
      }

      modal.style.display = 'block';

      fetch(`/api/gym/${gymId}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json'
        }
      })
              .then(response => response.json())
              .then(data => {
                detailContent.innerHTML = `
           <div class="gym-info">
               <div class="gym-header">
                   <h3 class="gym-name">${data.gName || '이름 없음'}</h3>
                   <div class="gym-category">${translateCategory(data.category) || '카테고리 없음'}</div>
               </div>

               <div class="gym-info-grid">
                   <div class="info-item">
                       <div class="info-label">평점</div>
                       <div class="gym-rating">★ ${data.rating || 'N/A'}</div>
                   </div>
                   <div class="info-item">
                       <div class="info-label">주소</div>
                       <div class="gym-address">${data.address || '정보 없음'}</div>
                   </div>
                   <div class="info-item">
                       <div class="info-label">운영시간</div>
                       <div class="gym-hours">${data.openHour || '정보 없음'}</div>
                   </div>
                   <div class="info-item">
                       <div class="info-label">연락처</div>
                       <div class="gym-phone">${data.phone || '정보 없음'}</div>
                   </div>
                   <div class="info-item">
                       <div class="info-label">홈페이지</div>
                       <div class="gym-homepage">${data.homepage ?
                        `<a href="${data.homepage}" target="_blank">${data.homepage}</a>` :
                        '정보 없음'}</div>
                   </div>
               </div>
           </div>

           <div class="gym-reviews">
               <h3>리뷰</h3>
               <div class="reviews-container">
                   ${data.reviews && data.reviews.length > 0 ?
                        data.reviews.map(review => `
                           <div class="review-card">
                               <div class="review-header">
                                   <div class="reviewer-info">
                                       <img src="${review.userProfileImage || '/default-profile.png'}"
                                            alt="프로필"
                                            class="reviewer-profile">
                                       <div class="reviewer-details">
                                           <div class="reviewer-name">${review.userName || '사용자'}</div>
                                       </div>
                                   </div>
                                   <div class="review-date">${formatDate(review.createdAt)}</div>
                               </div>
                               <div class="review-content">
                                   ${review.comment}
                               </div>
                               ${review.images ? `
                                   <div class="review-images">
                                       ${review.images.map(img => `
                                           <img src="${img}" alt="리뷰 이미지" class="review-image">
                                       `).join('')}
                                   </div>
                               ` : ''}
                               <div class="review-actions">
                                   <button class="comment-button">
                                       <i class="comment-icon">💬</i>
                                       <span class="comment-count">${review.commentCount || 0}</span>
                                   </button>
                               </div>
                           </div>
                       `).join('') :
                        '<p>아직 리뷰가 없습니다.</p>'
                }
               </div>
           </div>
       `;
              })
              .catch(error => {
                console.error('에러:', error);
                detailContent.innerHTML = `
           <div class="error-message">
               데이터를 불러오는데 실패했습니다: ${error.message}
           </div>
       `;
              });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }).format(date);
    }

    function translateCategory(category) {
      const categories = {
        'physics': '피트니스',
        'water': '수영',
        'ball': '구기종목',
        'battle': '격투기'
      };
      return categories[category] || category;
    }

    function closeModal() {
      const modal = document.getElementById('gymModal');
      modal.style.display = 'none';
    }

    // 모달 외부 클릭 시 닫기
    window.onclick = function(event) {
      const modal = document.getElementById('gymModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    // 페이지 로드시 실행
    document.addEventListener('DOMContentLoaded', fetchGyms);
  </script>
</body>
</html>