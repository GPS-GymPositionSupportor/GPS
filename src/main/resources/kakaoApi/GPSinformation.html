<!DOCTYPE html>
<html lang="kor">
<head>
    <meta charset="utf-8">
    <title>Kakao Map API - 헬스장 정보 수집</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=023855f0a78a87bb9407e335c59f0005&libraries=services"></script>
    <style>
        #map {
            width: 500px;
            height: 400px;
            border: 1px solid #ccc;
        }
        #status {
            margin-top: 10px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<h1>카카오맵 API로 헬스장 정보 수집</h1>
<div id="map"></div>
<button id="fetchButton" onclick="fetchGyms()">헬스장 정보 수집</button>
<p id="status">헬스장 정보를 수집하려면 버튼을 클릭하세요.</p>

<script>
    // 카카오맵 API를 이용한 지도 생성
    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567), // 초기 중심좌표 설정 (서울)
            level: 8 // 초기 확대 레벨 설정
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var ps = new kakao.maps.services.Places(); // 장소 검색 객체 생성

    // 전국의 시/군/구 리스트 (간단한 예시)
    var regions = [
        "서울 관악구", "서울 강동구", "부산 해운대구", "대구 중구", "광주 북구", // 각 지역 추가
        // ... 전국의 모든 시/군/구를 여기에 추가
    ];

    // 현재 수집 중인 헬스장 데이터를 저장하는 배열
    var gymData = [];

    // 헬스장 정보를 수집하는 함수
    async function fetchGyms() {
        document.getElementById('status').innerText = '헬스장 정보를 수집 중입니다...';
        document.getElementById('fetchButton').disabled = true; // 버튼 비활성화

        const promises = regions.map(region => fetchGymsByRegion(region));
        await Promise.all(promises);

        console.log(gymData); // 수집된 gymData 확인

        // 각 gymData 항목의 gName 확인
        gymData.forEach(gym => {
            console.log('gName:', gym.gName); // gName 출력
        });

        document.getElementById('status').innerText = `총 수집된 헬스장 수: ${gymData.length}`;
        sendGymDataToServer(gymData);
        document.getElementById('fetchButton').disabled = false; // 버튼 활성화
    }

    // 지역별로 헬스장을 검색하는 함수
    async function fetchGymsByRegion(region) {
        return new Promise((resolve, reject) => {
            ps.keywordSearch(region + ' 헬스장', function (data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    for (var i = 0; i < data.length; i++) {
                        gymData.push({
                            gName: data[i].place_name,
                            address: data[i].road_address_name,
                            gLatitude: data[i].y,
                            gLongitude: data[i].x,
                        });
                    }
                    resolve();
                } else {
                    console.error(`Error fetching gyms for ${region}:`, status);
                    reject(status);
                }
            });
        });
    }

    // 수집된 헬스장 데이터를 Spring Boot 서버로 전송하는 함수
    function sendGymDataToServer(gymData) {
        console.log("Sending the following gym data to server:", gymData); // 전송되는 데이터 확인
        fetch('http://localhost:8080/api/gyms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gymData)
        })
            .then(response => {
                // 응답이 JSON 형식인지 확인
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error); // JSON에서 오류 메시지 추출
                    });
                }
                return response.json(); // 정상적인 경우 JSON 파싱
            })
            .then(data => {
                console.log('Success:', data);
                document.getElementById('status').innerText = '헬스장 정보가 서버에 저장되었습니다.';
            })
            .catch((error) => {
                console.error('Error:', error);
                document.getElementById('status').innerText = '헬스장 정보 저장 중 오류가 발생했습니다: ' + error.message;
            });
    }
</script>
</body>
</html>
